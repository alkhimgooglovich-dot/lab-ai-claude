"""
Словарь единиц измерения лабораторных анализов.

KNOWN_UNITS — набор нормализованных единиц (≥30).
normalize_unit(raw) — приведение к стандартной форме.
is_valid_unit(text) — проверка, что строка похожа на единицу.
"""

import re
from typing import Dict, Set

# ──────────────────────────────────────────────
# Словарь известных единиц (нормализованная форма → множество написаний)
# ──────────────────────────────────────────────
_RAW_TO_NORM: Dict[str, str] = {
    # Клетки крови
    "*10^9/л":   "*10^9/л",
    "10^9/л":    "*10^9/л",
    "10*9/л":    "*10^9/л",
    "×10^9/л":   "*10^9/л",
    "х10^9/л":   "*10^9/л",
    "*10^12/л":  "*10^12/л",
    "10^12/л":   "*10^12/л",
    "10*12/л":   "*10^12/л",
    "×10^12/л":  "*10^12/л",
    "х10^12/л":  "*10^12/л",
    # Массовые
    "г/л":       "г/л",
    "г/дл":      "г/дл",
    "мг/л":      "мг/л",
    "мг/дл":     "мг/дл",
    "нг/мл":     "нг/мл",
    "мкг/л":     "мкг/л",
    "мкг/мл":    "мкг/мл",
    "мкг/дл":    "мкг/дл",
    "пг":        "пг",
    "пг/мл":     "пг/мл",
    # Молярные
    "ммоль/л":   "ммоль/л",
    "мкмоль/л":  "мкмоль/л",
    "нмоль/л":   "нмоль/л",
    "пмоль/л":   "пмоль/л",
    # Ферменты / активность
    "ед/л":      "Ед/л",
    "Ед/л":      "Ед/л",
    "МЕ/мл":     "МЕ/мл",
    "ме/мл":     "МЕ/мл",
    "МЕ/л":      "МЕ/л",
    "ме/л":      "МЕ/л",
    "мМЕ/мл":    "мМЕ/мл",
    "мме/мл":    "мМЕ/мл",
    "мкМЕ/мл":   "мкМЕ/мл",
    "мкме/мл":   "мкМЕ/мл",
    # Скорости / время
    "мм/ч":      "мм/ч",
    "мм/час":    "мм/ч",
    "сек":       "сек",
    "с":         "с",
    # Объём / размер
    "фл":        "фл",
    "фл.":       "фл",
    "л":         "л",
    "мл":        "мл",
    # Проценты
    "%":         "%",
    # Прочие
    "кл/мкл":    "кл/мкл",
    "тыс/мкл":   "тыс/мкл",
    "млн/мкл":   "млн/мкл",
    "копий/мл":  "копий/мл",
    "мОсм/кг":   "мОсм/кг",
    "мОсм/л":    "мОсм/л",
    "мЕд/л":     "мЕд/л",
    "мед/л":     "мЕд/л",
    "нг/дл":     "нг/дл",
    "пг/мл":     "пг/мл",
}

# Множество нормализованных единиц (для быстрой проверки)
KNOWN_UNITS: Set[str] = set(_RAW_TO_NORM.values())


def normalize_unit(raw: str) -> str:
    """
    Приводит сырую единицу к стандартной форме.

    Примеры:
        '10*9/л' → '*10^9/л'
        'мм/час' → 'мм/ч'
        'фл.'   → 'фл'
        'Ед/л'  → 'Ед/л'
        'XYZ'   → 'XYZ'  (неизвестная — возвращаем как есть)
    """
    s = (raw or "").strip()
    if not s:
        return ""

    # Прямой поиск
    norm = _RAW_TO_NORM.get(s)
    if norm:
        return norm

    # Поиск без учёта регистра
    s_lower = s.lower()
    for key, val in _RAW_TO_NORM.items():
        if key.lower() == s_lower:
            return val

    # Нормализация *10^N внутри строки
    s2 = re.sub(r"10\s*\*\s*(\d+)", r"10^\1", s)
    s2 = re.sub(r"[×хx]\s*10\s*\^\s*(\d+)", r"*10^\1", s2, flags=re.IGNORECASE)
    if s2 != s:
        norm = _RAW_TO_NORM.get(s2)
        if norm:
            return norm

    return s  # неизвестная единица — возвращаем как есть


def is_valid_unit(text: str) -> bool:
    """
    Проверяет, что строка выглядит как единица измерения.
    Возвращает True, если:
      - строка есть в словаре (точно или без регистра);
      - или строка содержит '/' и хотя бы одну букву (вероятная единица).
    """
    s = (text or "").strip()
    if not s:
        return False

    if normalize_unit(s) in KNOWN_UNITS:
        return True

    # Эвристика: символ '/' + буквы → вероятная единица
    if "/" in s and re.search(r"[A-Za-zА-Яа-я]", s):
        return True

    # '%' — тоже единица
    if s == "%":
        return True

    return False



