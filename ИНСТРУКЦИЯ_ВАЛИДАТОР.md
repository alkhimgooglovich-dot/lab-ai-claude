# Инструкция по запуску авто-валидатора

## Быстрый старт

### Шаг 1: Активируйте виртуальное окружение

**Windows (PowerShell):**
```powershell
cd C:\LAB-AI
.\venv\Scripts\Activate.ps1
```

**Windows (CMD):**
```cmd
cd C:\LAB-AI
venv\Scripts\activate.bat
```

**Linux/Mac:**
```bash
cd /path/to/LAB-AI
source venv/bin/activate
```

### Шаг 2: Запустите валидатор

```bash
python test_validator.py
```

## Что вы увидите

### ✅ Успешный запуск

```
[ВАЛИДАТОР] Запуск авто-валидатора...

[OK] Парсинг чисел
[OK] Парсинг референсных диапазонов
[OK] Определение статусов
[OK] Парсинг с процентами лейкоформулы
[OK] Обработка *10^9/*10^12
[OK] Определение типа панели
[OK] Очистка единиц измерения
[OK] Полный workflow

============================================================
Результаты: [OK] 8 пройдено, [FAIL] 0 провалено
============================================================

[УСПЕХ] Все тесты пройдены! Код готов к использованию.
```

### ❌ Если есть ошибки

```
[FAIL] Определение статусов: RBC 4.00 при норме 3.80-5.10 должен быть В НОРМЕ, получен: ВЫШЕ
[ERROR] Парсинг с процентами: неожиданная ошибка - ...

============================================================
Результаты: [OK] 6 пройдено, [FAIL] 2 провалено
============================================================

[ВНИМАНИЕ] Обнаружены ошибки! Исправьте их перед использованием.
```

## Решение проблем

### Проблема: "ModuleNotFoundError: No module named 'requests'"

**Решение:**
1. Убедитесь, что виртуальное окружение активировано
2. Установите зависимости:
   ```bash
   pip install requests jinja2 playwright cryptography
   ```

### Проблема: "ImportError: cannot import name 'detect_panel'"

**Решение:**
Убедитесь, что функция `detect_panel` определена в `engine.py` на уровне модуля (не внутри другой функции).

### Проблема: Кодировка/эмодзи не отображаются

**Решение:**
Валидатор автоматически исправляет кодировку для Windows. Если проблема остаётся, запустите в терминале с поддержкой UTF-8.

## Когда запускать валидатор

1. **Перед коммитом** изменений в `engine.py`
2. **После исправления багов** — убедиться, что регрессий нет
3. **Перед деплоем** — финальная проверка
4. **После обновления зависимостей** — проверить совместимость

## Что проверяет валидатор

### Критичные проверки (предотвращают основные баги):

1. ✅ **Правильная классификация статусов**
   - RBC 4.00 (3.80–5.10) → В НОРМЕ (не ВЫШЕ!)
   - PLT 199 (150–400) → В НОРМЕ (не НИЖЕ!)

2. ✅ **Проценты лейкоформулы не удаляются**
   - NE%, LY%, MO%, EO%, BA% должны оставаться после фильтрации

3. ✅ **Единицы измерения сохраняются**
   - *10^9/л, *10^12/л не теряются

4. ✅ **Определение панели анализов**
   - Биохимия не требует показателей ОАК

## Добавление новых тестов

Если вы нашли новый баг, добавьте тест в `test_validator.py`:

```python
def test_new_bug_prevention():
    """Описание что проверяем"""
    # Подготовка данных
    data = "..."
    
    # Выполнение функции
    result = function_under_test(data)
    
    # Проверка
    assert result == expected, "Что должно быть"
    return True
```

Затем добавьте тест в список `tests` в функции `run_all_tests()`.

## Автоматизация

Можно добавить валидатор в pre-commit hook или CI/CD:

```bash
# В .git/hooks/pre-commit (Linux/Mac)
#!/bin/bash
python test_validator.py || exit 1
```

Или в GitHub Actions / GitLab CI.

