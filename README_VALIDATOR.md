# Авто-валидатор для предотвращения регрессий

## Запуск валидатора

```bash
python test_validator.py
```

## Что проверяет валидатор

### 1. Парсинг чисел
- Корректное преобразование строк в float
- Обработка различных форматов (4.00, 199, 28.0 и т.д.)

### 2. Парсинг референсных диапазонов
- Обычные диапазоны: "3.80-5.10", "150-400"
- Защита от перепутанных low/high: "5.10-3.80" → исправляется

### 3. Определение статусов (КРИТИЧНО)
Проверяет правильность классификации:
- **RBC 4.00 (3.80–5.10)** → В НОРМЕ
- **PLT 199 (150–400)** → В НОРМЕ  
- **СОЭ 28 (2–20)** → ВЫШЕ
- **HCT 34.7 (35.0–45.0)** → НИЖЕ
- Граничные значения (3.8 при норме 3.8–5.1) → В НОРМЕ

### 4. Парсинг процентов лейкоформулы (КРИТИЧНО)
Проверяет, что проценты (NE%, LY%, MO%, EO%, BA%):
- Распознаются из кандидатов
- **НЕ удаляются** функцией `drop_percent_if_absolute()`
- Имеют правильные статусы (ВЫШЕ/НИЖЕ/В НОРМЕ)

### 5. Обработка единиц измерения *10^9/*10^12
- Корректное извлечение единиц: "*10^9/л", "*10^12/л"
- Единицы сохраняются и отображаются правильно

### 6. Очистка единиц от повторяющихся референсов
- Единица "*10^9/л 0.02 - 0.50" → "*10^9/л"

### 7. Определение типа панели анализов
- CBC (ОАК): определяется по маркерам WBC, RBC, HGB и т.д.
- Биохимия: определяется по маркерам ALT, AST, CREA и т.д.
- Липидограмма: определяется по маркерам CHOL, LDL, HDL, TRIG

### 8. Интеграционный тест полного workflow
- Парсинг реальных данных
- Проверка всех отклонений
- Проверка полноты данных

## Когда запускать

1. **Перед коммитом** изменений в `engine.py`
2. **После исправления багов** — убедиться, что регрессий нет
3. **Перед деплоем** — финальная проверка

## Добавление новых тестов

Если вы нашли новый баг, который нужно предотвратить:

1. Добавьте тест в `test_validator.py`
2. Убедитесь, что тест падает для текущей версии (если баг есть)
3. Исправьте баг
4. Убедитесь, что тест проходит

Пример:
```python
def test_new_feature():
    """Описание что проверяем"""
    # Подготовка
    data = "..."
    
    # Действие
    result = function_under_test(data)
    
    # Проверка
    assert result == expected, "Что должно быть"
    return True
```

Затем добавьте тест в список `tests` в функции `run_all_tests()`.

