<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Расшифровка анализов — отчёт</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f7fa;color:#1f2937;margin:0;padding:24px}
    .container{max-width:920px;margin:auto;background:#fff;border-radius:12px;padding:32px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
    h1{font-size:28px;margin:0 0 6px}
    .sub{color:#6b7280;margin:0 0 16px}
    h2{font-size:20px;margin-top:28px;border-bottom:1px solid #e5e7eb;padding-bottom:6px}
    p{line-height:1.6;margin:10px 0}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:6px 12px;border-radius:999px;font-size:13px;margin-bottom:16px}
    .disclaimer{background:#fff7ed;border-left:4px solid #f97316;padding:14px;margin:18px 0;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    th{background:#f9fafb;font-weight:600}
    .muted{color:#6b7280}
    ul{padding-left:20px;margin:10px 0}
    li{margin:6px 0}
    .footer{margin-top:30px;font-size:12px;color:#6b7280;text-align:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Градация статусов */
    .status-normal{color:#047857;font-weight:800}  /* зелёный */
    .status-warn{color:#b45309;font-weight:800}    /* жёлто-оранжевый */
    .status-high{color:#b91c1c;font-weight:800}    /* красный */
  </style>
</head>
<body>
  <div class="container">
    <span class="badge">Информационный отчёт</span>
    <h1>Расшифровка лабораторных анализов</h1>
    <p class="sub">
      Пол: <strong>{{ sex }}</strong> · Возраст: <strong>{{ age }}</strong> ·
      Сформировано: <strong>{{ created_at }}</strong>
    </p>

    <div class="disclaimer">
      <strong>Дисклеймер:</strong><br>
      Представленная информация носит справочный характер, не является медицинским заключением, диагнозом или рекомендацией по лечению.
      Для интерпретации результатов и принятия решений необходимо обратиться к врачу.
    </div>

    <h2>Краткий итог по фактам</h2>
    {% if missing_warnings|length > 0 %}
      <div class="card" style="background:#fff7ed; border-left:4px solid #f97316; padding:14px; margin-bottom:16px;">
        <strong>⚠️ Предупреждение:</strong><br>
        {% for warn in missing_warnings %}
          {{ warn }}<br>
        {% endfor %}
        {% if "Распознано мало показателей" not in missing_warnings|join(", ") %}
          Проверьте качество файла или загрузите другой формат.
        {% endif %}
      </div>
    {% endif %}
    {% if facts|length == 0 %}
      <div class="card">По распознанным референсам явных отклонений не найдено (или нормы не распознаны).</div>
    {% else %}
      <ul>
        {% for f in facts %}
          <li>{{ f | safe }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <h2>Технический разбор (по референсам)</h2>
    <table>
      <thead>
        <tr>
          <th>Показатель</th>
          <th>Значение</th>
          <th>Норма</th>
          <th>Источник</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td class="mono">{{ r.code }}</td>
          <td>{{ r.value }}{% if r.unit %} {{ r.unit }}{% endif %}</td>
          <td class="muted">{{ r.ref_text if r.ref_text else "—" }}</td>
          <td class="muted">{{ r.ref_source }}</td>

          {# ВАЖНО: класс приходит из Python как r.status_class (зел/желт/красн/серый) #}
          <td class="{{ r.status_class if r.status_class else 'muted' }}">
            {{ r.status }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if explain_lines|length > 0 %}
    <h2>Пояснения (из словаря, без ИИ)</h2>
    <div class="grid">
      {% for line in explain_lines %}
        <div class="card">{{ line | safe }}</div>
      {% endfor %}
    </div>
    {% endif %}

    <h2>Расшифровка (человечески)</h2>
    <div class="card">
      {{ human_text | replace("\n","<br>") | safe }}
    </div>

    <div class="footer">
      Автоматически сформировано • MVP • Сырой ответ API: <span class="mono">{{ raw_path }}</span>
    </div>
  </div>
</body>
</html>
